<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåø Herbarium OCR Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }
        .processing-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .stat-card {
            transition: transform 0.2s ease-in-out;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-gray-100" x-data="dashboard()">
    <!-- Header -->
    <header class="gradient-bg shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center">
                    <h1 class="text-3xl font-bold text-white">üåø Herbarium OCR</h1>
                    <span class="ml-4 px-3 py-1 bg-white bg-opacity-20 rounded-full text-white text-sm">
                        v1.0.0
                    </span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-white text-sm">
                        <span x-show="status.current_image" class="processing-animation">
                            üîÑ Processing: <span x-text="status.current_image"></span>
                        </span>
                        <span x-show="!status.current_image">
                            ‚è∏Ô∏è Ready
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Images -->
            <div class="stat-card bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="text-3xl">üìä</div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Total Images</dt>
                                <dd class="text-3xl font-bold text-gray-900" x-text="status.total_images">0</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Processed -->
            <div class="stat-card bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="text-3xl">‚úÖ</div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Processed</dt>
                                <dd class="text-3xl font-bold text-green-600" x-text="status.processed">0</dd>
                            </dl>
                        </div>
                    </div>
                    <div class="mt-2">
                        <div class="bg-gray-200 rounded-full h-2">
                            <div class="bg-green-500 h-2 rounded-full transition-all duration-300"
                                 :style="`width: ${status.total_images > 0 ? (status.processed / status.total_images * 100) : 0}%`"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Success Rate -->
            <div class="stat-card bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="text-3xl">üìà</div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Success Rate</dt>
                                <dd class="text-3xl font-bold text-blue-600"
                                    x-text="status.processed > 0 ? Math.round(status.successful / status.processed * 100) + '%' : '0%'">0%</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Failed -->
            <div class="stat-card bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="text-3xl">‚ùå</div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Failed</dt>
                                <dd class="text-3xl font-bold text-red-600" x-text="status.failed">0</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts and Details -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Engine Usage Chart -->
            <div class="bg-white shadow rounded-lg p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">ü§ñ Engine Usage</h3>
                <canvas id="engineChart" width="400" height="200"></canvas>
            </div>

            <!-- Processing Timeline -->
            <div class="bg-white shadow rounded-lg p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">‚è±Ô∏è Processing Timeline</h3>
                <div x-show="status.start_time">
                    <p class="text-sm text-gray-600">Started: <span x-text="formatTime(status.start_time)"></span></p>
                    <p class="text-sm text-gray-600">Elapsed: <span x-text="getElapsedTime()"></span></p>
                    <p class="text-sm text-gray-600" x-show="status.processed > 0">
                        Rate: <span x-text="getProcessingRate()"></span> images/sec
                    </p>
                </div>
                <div x-show="!status.start_time" class="text-gray-500 text-center py-8">
                    No active processing session
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">üìã Recent Activity</h3>
            </div>
            <div class="px-6 py-4">
                <div class="flow-root">
                    <ul class="-mb-8">
                        <template x-for="(error, index) in status.errors.slice(-5)" :key="index">
                            <li class="relative pb-8">
                                <div class="flex items-start space-x-3">
                                    <div class="flex-shrink-0">
                                        <div class="h-8 w-8 rounded-full bg-red-100 flex items-center justify-center">
                                            <span class="text-red-500 text-sm">‚ùå</span>
                                        </div>
                                    </div>
                                    <div class="min-w-0 flex-1">
                                        <div>
                                            <p class="text-sm text-gray-900" x-text="error"></p>
                                            <p class="text-xs text-gray-500" x-text="formatTime(new Date().toISOString())"></p>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </template>
                        <div x-show="status.errors.length === 0" class="text-center py-8 text-gray-500">
                            No recent errors
                        </div>
                    </ul>
                </div>
            </div>
        </div>
    </main>

    <script>
        function dashboard() {
            return {
                status: {
                    total_images: 0,
                    processed: 0,
                    successful: 0,
                    failed: 0,
                    current_image: null,
                    start_time: null,
                    errors: [],
                    engine_stats: {}
                },
                chart: null,

                init() {
                    this.connectWebSocket();
                    this.initChart();
                },

                connectWebSocket() {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

                    ws.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        this.status = { ...this.status, ...data };
                        this.updateChart();
                    };

                    ws.onclose = () => {
                        console.log('WebSocket connection closed. Attempting to reconnect...');
                        setTimeout(() => this.connectWebSocket(), 3000);
                    };
                },

                initChart() {
                    const ctx = document.getElementById('engineChart').getContext('2d');
                    this.chart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: [],
                            datasets: [{
                                data: [],
                                backgroundColor: [
                                    '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                },

                updateChart() {
                    if (!this.chart) return;

                    const engines = Object.keys(this.status.engine_stats);
                    const counts = Object.values(this.status.engine_stats);

                    this.chart.data.labels = engines;
                    this.chart.data.datasets[0].data = counts;
                    this.chart.update();
                },

                formatTime(isoString) {
                    if (!isoString) return '';
                    return new Date(isoString).toLocaleTimeString();
                },

                getElapsedTime() {
                    if (!this.status.start_time) return '';
                    const start = new Date(this.status.start_time);
                    const now = new Date();
                    const elapsed = Math.floor((now - start) / 1000);

                    const hours = Math.floor(elapsed / 3600);
                    const minutes = Math.floor((elapsed % 3600) / 60);
                    const seconds = elapsed % 60;

                    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                },

                getProcessingRate() {
                    if (!this.status.start_time || this.status.processed === 0) return '0';
                    const start = new Date(this.status.start_time);
                    const now = new Date();
                    const elapsed = (now - start) / 1000;

                    const rate = this.status.processed / elapsed;
                    return rate.toFixed(1);
                }
            }
        }
    </script>
</body>
</html>
